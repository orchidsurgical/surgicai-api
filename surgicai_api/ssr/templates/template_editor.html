{% extends "base.html" %}

{% block title %}Template Editor - OperativeAI{% endblock %}

{% block head %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<style>
  .editor-container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: margin-right 0.3s ease;
  }
  
  .editor-container.panel-open {
    margin-right: 350px;
  }
  
  .editor-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .editor-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    outline: none;
    cursor: text;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  
  .editor-title:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .editor-title:focus {
    background-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
  }
  
  .editor-title::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }
  
  .editor-title.modified {
    box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5);
  }
  
  .editor-title.modified::after {
    content: "*";
    color: rgba(255, 193, 7, 0.8);
    margin-left: 0.25rem;
  }
  
  .editor-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
  }
  
  .status-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
  }
  
  .unsaved-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    background: rgba(255, 193, 7, 0.2);
    color: rgba(255, 193, 7, 0.9);
    backdrop-filter: blur(10px);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }
  
  .template-info {
    background: #f8f9fa;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
  }
  
  .template-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  
  .info-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .info-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .info-value {
    font-size: 1rem;
    color: var(--dark-text);
    font-weight: 500;
  }
  
  .info-input {
    font-size: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.5rem;
    background: white;
    color: var(--dark-text);
    transition: border-color 0.2s ease;
  }
  
  .info-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
  }
  
  .info-input.modified {
    border-color: #ffc107;
    box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.1);
  }
  
  .editor-toolbar {
    background: white;
    padding: 1rem 2rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: between;
    align-items: center;
    gap: 1rem;
  }
  
  .toolbar-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .toolbar-separator {
    width: 1px;
    height: 24px;
    background: #dee2e6;
    margin: 0 0.5rem;
  }
  
  .editor-content {
    padding: 0;
    min-height: 500px;
  }
  
  .quill-container {
    border: none;
    height: 500px;
  }
  
  .ql-editor {
    padding: 2rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    font-size: 12pt !important;
    line-height: 1.6;
    color: var(--dark-text);
    min-height: 456px;
  }
  
  /* Template field highlighting in editor */
  .ql-editor .ql-background-#fff3cd {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
    border: 2px solid #ffc107 !important;
    border-radius: 4px !important;
    padding: 2px 4px !important;
    font-weight: 600 !important;
    display: inline-block !important;
    margin: 0 1px !important;
    position: relative !important;
    animation: highlight-pulse 2s infinite !important;
  }
  
  .ql-editor span[style*="background: rgb(255, 243, 205)"] {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
    border: 2px solid #ffc107 !important;
    border-radius: 4px !important;
    padding: 2px 4px !important;
    font-weight: 600 !important;
    display: inline-block !important;
    margin: 0 1px !important;
    position: relative !important;
    animation: highlight-pulse 2s infinite !important;
  }
  
  .ql-editor.ql-blank::before {
    left: 2rem;
    right: 2rem;
    font-style: italic;
    color: #999;
  }
  
  .ql-toolbar {
    display: none !important;
  }
  
  .ql-toolbar .ql-formats {
    margin-right: 1rem;
  }
  
  /* Template field highlighting */
  .template-field {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    border-radius: 4px;
    padding: 2px 4px;
    font-weight: 600;
    color: #856404;
    position: relative;
    display: inline-block;
    animation: highlight-pulse 2s infinite;
  }
  
  .template-field::before {
    content: "üìù";
    font-size: 0.8em;
    margin-right: 2px;
  }
  
  .template-field-overlay {
    animation: fadeInUp 0.3s ease;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes highlight-pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
    70% { box-shadow: 0 0 0 6px rgba(255, 193, 7, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
  }
  
  /* Field count indicator */
  .field-count-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #0066cc;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
  }
  
  .field-count-indicator.show {
    display: block;
  }
  
  .template-fields-help {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .template-fields-help h6 {
    color: #0066cc;
    margin-bottom: 0.5rem;
  }
  
  .template-fields-help p {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #333;
  }
  
  .template-fields-help .example {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
    font-family: monospace;
    font-size: 0.85rem;
    margin: 0.5rem 0;
  }
  
  .save-indicator {
    position: fixed;
    top: 100px;
    right: 20px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 1000;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(-10px);
  }
  
  .save-indicator.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .save-indicator.saving {
    background: #fff3cd;
    border-color: #ffc107;
    color: #856404;
  }
  
  .save-indicator.saved {
    background: #d1e7dd;
    border-color: #198754;
    color: #0a3622;
  }
  
  .save-indicator.error {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
  }
  
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-left: auto;
  }
  
  .btn-outline-primary {
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    background: transparent;
  }
  
  .btn-outline-primary:hover {
    background: var(--primary-color);
    color: white;
  }
  
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .loading-overlay.show {
    opacity: 1;
    visibility: visible;
  }
  
  .loading-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @media (max-width: 768px) {
    .editor-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .template-info-grid {
      grid-template-columns: 1fr;
    }
    
    .editor-toolbar {
      padding: 1rem;
    }
    
    .ql-editor {
      padding: 1rem;
    }
    
    .save-indicator {
      right: 10px;
      top: 80px;
    }
    
    .editor-container.panel-open {
      margin-right: 0;
    }
    
    .help-panel {
      width: 100% !important;
      right: -100% !important;
    }
    
    .help-panel.open {
      right: 0 !important;
    }
  }
  
  /* Help Panel Styles */
  .help-panel {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100vh;
    background: white;
    border-left: 1px solid #e9ecef;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: right 0.3s ease;
    overflow-y: auto;
  }
  
  .help-panel.open {
    right: 0;
  }
  
  .help-panel-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1002;
  }
  
  .help-panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
  }
  
  .help-panel-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  
  .help-panel-close:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .help-panel-content {
    padding: 1.5rem;
  }
  
  .help-section {
    margin-bottom: 2rem;
  }
  
  .help-section:last-child {
    margin-bottom: 0;
  }
  
  .help-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .help-section-content {
    color: #333;
    line-height: 1.6;
  }
  
  .help-section-content p {
    margin-bottom: 0.75rem;
  }
  
  .help-section-content p:last-child {
    margin-bottom: 0;
  }
  
  .help-code {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    margin: 0.5rem 0;
    display: block;
  }
  
  .help-example {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 6px;
    padding: 1rem;
    margin: 0.75rem 0;
  }
  
  .help-example-title {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  
  .help-example-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    color: #333;
    white-space: pre-wrap;
  }
  
  .keyboard-shortcut {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .keyboard-shortcut:last-child {
    border-bottom: none;
  }
  
  .shortcut-description {
    color: #333;
    font-size: 0.9rem;
  }
  
  .shortcut-keys {
    display: flex;
    gap: 0.25rem;
  }
  
  .shortcut-key {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    color: #333;
    min-width: 1.5rem;
    text-align: center;
  }
  
  .help-toggle-btn {
    position: fixed;
    top: 50%;
    right: 20px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transform: translateY(-50%);
  }
  
  .help-toggle-btn:hover {
    background: var(--secondary-color);
    transform: translateY(-50%) scale(1.05);
  }
  
  .help-toggle-btn.panel-open {
    right: 370px;
  }
  
  /* Modal Styling */
  .modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border-bottom: none;
  }
  
  .modal-header .btn-close {
    filter: invert(1);
  }
  
  .modal-body {
    padding: 2rem;
  }
  
  .modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1rem 2rem;
  }
  
  .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }
  
  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.1);
  }
  
  .alert-info {
    background-color: #e7f3ff;
    border-color: #b3d9ff;
    color: #0c5460;
  }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading template...</div>
  </div>
</div>

<div class="container-fluid py-4">
  <div class="editor-container">
    <div class="editor-header">
      <input type="text" class="editor-title" id="templateName" placeholder="Enter template name..." maxlength="255">
      <div class="editor-status">
        <span class="unsaved-indicator" id="unsavedIndicator" style="display: none;">
          <i class="bi bi-exclamation-circle me-1"></i>Unsaved changes
        </span>
        <span id="lastUpdated">...</span>
      </div>
    </div>
    
    <div class="template-info" id="templateInfo">
      <div class="template-info-grid">
        <div class="info-field">
          <div class="info-label">Template Name</div>
          <input type="text" class="info-input" id="templateNameField" placeholder="Enter template name">
        </div>
        <div class="info-field">
          <div class="info-label">Default Title</div>
          <input type="text" class="info-input" id="defaultTitle" placeholder="Default title for new operative notes">
        </div>
        <div class="info-field">
          <div class="info-label">Last Updated</div>
          <div class="info-value" id="lastUpdatedField">-</div>
        </div>
        <div class="info-field">
          <div class="info-label">Template Fields</div>
          <div class="info-value" id="fieldCount">
            <span id="templateFieldsCount">0 fields detected</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="editor-toolbar">
      <div class="toolbar-group">
        <button class="btn btn-sm btn-outline-primary" onclick="insertTemplateField()">
          <i class="bi bi-plus-circle me-1"></i>Insert Field
        </button>
        <div class="toolbar-separator"></div>
        <button class="btn btn-sm btn-outline-primary" onclick="toggleHelpPanel()">
          <i class="bi bi-question-circle me-1"></i>Help
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="previewTemplate()">
          <i class="bi bi-eye me-1"></i>Preview Template
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="createOpNoteFromTemplate()">
          <i class="bi bi-file-earmark-plus me-1"></i>Create OpNote from Template
        </button>
      </div>
      <div class="action-buttons">
        <button class="btn btn-sm btn-outline-primary" onclick="saveTemplate()" id="saveButton">
          <i class="bi bi-save me-1"></i>Save
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="backToTemplates()">
          <i class="bi bi-arrow-left me-1"></i>Back to Templates
        </button>
      </div>
    </div>
    
    <div class="editor-content">
      <div id="editor"></div>
    </div>
  </div>
</div>

<div class="save-indicator" id="saveIndicator">
  <span class="spinner" id="saveSpinner" style="display: none;"></span>
  <i class="bi bi-check-circle" id="saveIcon" style="display: none;"></i>
  <i class="bi bi-exclamation-triangle" id="errorIcon" style="display: none;"></i>
  <span id="saveMessage">Saved</span>
</div>

<div class="field-count-indicator" id="fieldCountIndicator">
  <i class="bi bi-file-earmark-text me-1"></i>
  <span id="fieldCountText">0 template fields</span>
</div>

<!-- Help Panel -->
<div class="help-panel" id="helpPanel">
  <div class="help-panel-header">
    <h3 class="help-panel-title">
      <i class="bi bi-question-circle me-2"></i>Template Editor Help
    </h3>
    <button class="help-panel-close" onclick="toggleHelpPanel()" aria-label="Close help panel">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  
  <div class="help-panel-content">
    <div class="help-section">
      <div class="help-section-title">
        <i class="bi bi-lightbulb"></i>
        Template Fields
      </div>
      <div class="help-section-content">
        <p>Use <code>***</code> to create template fields that will be replaced when creating operative notes.</p>
        
        <div class="help-example">
          <div class="help-example-title">Example Template:</div>
          <div class="help-example-content">Patient *** underwent *** procedure on ***.

PROCEDURE: ***
SURGEON: ***
ANESTHESIA: ***

FINDINGS:
***

PROCEDURE DETAILS:
***</div>
        </div>
        
        <p>Each <code>***</code> becomes a fillable field when creating an operative note from this template.</p>
      </div>
    </div>
    
    <div class="help-section">
      <div class="help-section-title">
        <i class="bi bi-keyboard"></i>
        Keyboard Shortcuts
      </div>
      <div class="help-section-content">
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Save template</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">S</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Save template (Mac)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">‚åò</span>
            <span class="shortcut-key">S</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Help Toggle Button -->
<button class="help-toggle-btn" id="helpToggleBtn" onclick="toggleHelpPanel()" aria-label="Toggle help panel">
  <i class="bi bi-question-circle"></i>
</button>

<!-- Create OpNote Modal -->
<div class="modal fade" id="createOpNoteModal" tabindex="-1" aria-labelledby="createOpNoteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createOpNoteModalLabel">
          <i class="bi bi-file-earmark-plus me-2"></i>Create Operative Note from Template
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createOpNoteForm">
          <div class="mb-3">
            <label for="opNoteTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="opNoteTitle" name="title" required>
          </div>
          <div class="mb-3">
            <label for="patientFirstName" class="form-label">Patient First Name</label>
            <input type="text" class="form-control" id="patientFirstName" name="patient_first_name">
          </div>
          <div class="mb-3">
            <label for="patientLastName" class="form-label">Patient Last Name</label>
            <input type="text" class="form-control" id="patientLastName" name="patient_last_name">
          </div>
          <div class="mb-3">
            <label for="operationDate" class="form-label">Operation Date & Time</label>
            <input type="datetime-local" class="form-control" id="operationDate" name="operation_datetime_start">
            <div class="form-text">Optional: Set the date and time of the operation</div>
          </div>
        </form>
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          This will create a new operative note using the content from this template. Template fields (***) will be preserved for you to fill in.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitCreateOpNote()">
          <i class="bi bi-file-earmark-plus me-1"></i>Create Operative Note
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  // Global variables
  let quill;
  let currentTemplate = null;
  let autoSaveInterval = null;
  let isLoading = false;
  let hasUnsavedChanges = false;
  let isInitialLoad = true; // Flag to prevent triggering unsaved changes during initial load
  let templateFieldCount = 0; // Track number of template fields
  
  // Initialize the editor
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Template editor page loaded');
    
    // Wait for Quill to load
    function waitForQuill() {
      if (typeof Quill !== 'undefined') {
        console.log('Quill is available, initializing editor...');
        initializeQuill();
        loadTemplate();
        setupAutoSave();
        setupBeforeUnload();
        setupChangeListeners();
        setupKeyboardShortcuts();
      } else {
        console.log('Waiting for Quill to load...');
        setTimeout(waitForQuill, 100);
      }
    }
    
    waitForQuill();
  });
  
  function initializeQuill() {
    try {
      const editorElement = document.getElementById('editor');
      if (!editorElement) {
        throw new Error('Editor element not found');
      }
      
      const toolbarOptions = false; // Disable all toolbar options
      
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: false // Completely disable toolbar
        },
        formats: ['background', 'color'], // Allow background and color for field highlighting
        placeholder: 'Start typing your template content...'
      });
      
      console.log('Quill initialized successfully');
      
      // Listen for text changes
      quill.on('text-change', function(delta, oldDelta, source) {
        if (source === 'user' && !isInitialLoad) {
          hasUnsavedChanges = true;
          updateSaveIndicator('modified');
          // Detect template fields with a longer delay to allow typing to complete
          clearTimeout(window.fieldDetectionTimeout);
          window.fieldDetectionTimeout = setTimeout(detectAndHighlightTemplateFields, 500);
        }
      });
    } catch (error) {
      console.error('Error initializing Quill:', error);
      showToast('Error initializing editor. Please refresh the page.', 'danger');
    }
  }
  
  function loadTemplate() {
    const templateId = '{{ template_id }}';
    console.log('Loading template:', templateId);
    
    showLoading(true);
    
    fetch(`/api/v1/template/${templateId}/`, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Template loaded:', data);
      currentTemplate = data;
      populateTemplate(data);
      hasUnsavedChanges = false;
      // Don't show any save indicator on initial load
    })
    .catch(error => {
      console.error('Error loading template:', error);
      showToast('Error loading template: ' + error.message, 'danger');
      updateSaveIndicator('error');
    })
    .finally(() => {
      showLoading(false);
    });
  }
  
  function populateTemplate(template) {
    // Update header title
    document.getElementById('templateName').value = template.name || '';
    
    // Update template info fields
    document.getElementById('templateNameField').value = template.name || '';
    document.getElementById('defaultTitle').value = template.title || '';
    
    // Update last updated with better formatting
    const lastUpdated = template.updated_at ? 
      new Date(template.updated_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      }) : 'Never';
    document.getElementById('lastUpdated').textContent = 'Last updated: ' + lastUpdated;
    
    // Format last updated date for the info field
    const lastUpdatedForField = template.updated_at ? 
      new Date(template.updated_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      }) : '-';
    document.getElementById('lastUpdatedField').textContent = lastUpdatedForField;
    
    // Set editor content as plain text
    if (template.text && quill) {
      // Set content as plain text only
      quill.setText(template.text, 'silent');
    } else if (template.text) {
      // Fallback if Quill isn't ready yet
      const editorElement = document.getElementById('editor');
      if (editorElement) {
        editorElement.textContent = template.text;
      }
    }
    
    // Reset initial load flag after template is fully populated
    setTimeout(() => {
      isInitialLoad = false;
      // Detect and highlight fields after initial load
      detectAndHighlightTemplateFields();
    }, 200); // Increased timeout to ensure content is set
  }
  
  function detectAndHighlightTemplateFields() {
    if (!quill) return;
    
    const text = quill.getText();
    
    // Find all *** patterns (just the three asterisks)
    const fieldPattern = /\*\*\*/g;
    let matches = [];
    let match;
    
    while ((match = fieldPattern.exec(text)) !== null) {
      matches.push({
        start: match.index,
        end: match.index + match[0].length,
        text: match[0],
        fieldName: `Field ${matches.length + 1}`
      });
    }
    
    // Update field count
    templateFieldCount = matches.length;
    updateFieldCountDisplay(matches);
    
    // Since we're in plain text mode, we'll use overlay indicators
    highlightFieldsInEditor(matches);
  }
  
  function highlightFieldsInEditor(matches) {
    if (!quill || matches.length === 0) {
      // Clear all formatting if no matches
      if (quill) {
        const fullRange = quill.getLength();
        quill.removeFormat(0, fullRange, 'silent');
      }
      return;
    }
    
    // Store current cursor position
    const currentSelection = quill.getSelection();
    
    // Clear all formatting first
    const fullRange = quill.getLength();
    quill.removeFormat(0, fullRange, 'silent');
    
    // Apply highlighting to each *** field
    matches.forEach((match, index) => {
      try {
        // Apply background color styling to the *** text
        quill.formatText(match.start, match.end - match.start, {
          'background': '#fff3cd',
          'color': '#856404'
        }, 'silent');
      } catch (error) {
        console.warn('Error highlighting field:', error);
      }
    });
    
    // Restore cursor position if it existed
    if (currentSelection) {
      quill.setSelection(currentSelection.index, currentSelection.length, 'silent');
    }
  }
  
  function updateFieldCountDisplay(matches = []) {
    const fieldCountElement = document.getElementById('fieldCount');
    const fieldCountIndicator = document.getElementById('fieldCountIndicator');
    const templateFieldsCountElement = document.getElementById('templateFieldsCount');
    const fieldCountTextElement = document.getElementById('fieldCountText');
    
    const count = matches.length;
    const countText = count === 1 ? '1 field detected' : `${count} fields detected`;
    const indicatorText = count === 1 ? '1 template field' : `${count} template fields`;
    
    if (templateFieldsCountElement) {
      templateFieldsCountElement.textContent = countText;
      if (count > 0) {
        templateFieldsCountElement.style.color = '#0066cc';
        templateFieldsCountElement.style.fontWeight = '600';
      } else {
        templateFieldsCountElement.style.color = '';
        templateFieldsCountElement.style.fontWeight = '';
      }
    }
    
    if (fieldCountTextElement) {
      fieldCountTextElement.textContent = indicatorText;
    }
    
    if (fieldCountIndicator) {
      if (count > 0) {
        fieldCountIndicator.classList.add('show');
      } else {
        fieldCountIndicator.classList.remove('show');
      }
    }
    
    // Update the help section - no need to show field positions for unnamed fields
    const existingFieldList = document.querySelector('.detected-fields');
    if (existingFieldList) {
      existingFieldList.remove();
    }
  }
  
  function insertTemplateField() {
    if (!quill) return;
    
    const selection = quill.getSelection();
    if (selection) {
      // Insert *** at the current cursor position
      quill.insertText(selection.index, '***', 'user');
      // Move cursor after the inserted field
      quill.setSelection(selection.index + 3);
    } else {
      // If no selection, insert at the end
      const length = quill.getLength();
      quill.insertText(length - 1, '***', 'user');
      quill.setSelection(length + 2);
    }
    
    // Trigger field detection after insertion
    setTimeout(() => {
      detectAndHighlightTemplateFields();
    }, 100);
  }
  
  function saveTemplate() {
    if (isLoading) return;
    
    const templateId = '{{ template_id }}';
    let content = '';
    
    if (quill) {
      content = quill.getText(); // Get plain text instead of HTML
    } else {
      // Fallback to get content from editor element
      const editorElement = document.getElementById('editor');
      if (editorElement) {
        content = editorElement.textContent || editorElement.innerText || '';
      }
    }
    
    const nameInput = document.getElementById('templateNameField');
    const titleInput = document.getElementById('defaultTitle');
    const headerNameInput = document.getElementById('templateName');
    
    const name = nameInput ? nameInput.value.trim() : '';
    const title = titleInput ? titleInput.value.trim() : '';
    
    if (!name) {
      showToast('Please enter a name for the template', 'warning');
      nameInput?.focus();
      return;
    }
    
    const updateData = {
      name: name,
      title: title || null,
      text: content || null
    };
    
    console.log('Saving template:', updateData);
    updateSaveIndicator('saving');
    
    fetch(`/api/v1/template/${templateId}/`, {
      method: 'PUT',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updateData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Template saved:', data);
      currentTemplate = data;
      hasUnsavedChanges = false;
      updateSaveIndicator('saved');
      
      // Update header name to match
      if (headerNameInput) {
        headerNameInput.value = data.name;
        headerNameInput.classList.remove('modified');
      }
      
      // Remove modified classes
      nameInput?.classList.remove('modified');
      titleInput?.classList.remove('modified');
      
      // Update last updated time with better formatting
      const lastUpdated = new Date(data.updated_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      document.getElementById('lastUpdated').textContent = 'Last updated: ' + lastUpdated;
      document.getElementById('lastUpdatedField').textContent = lastUpdated;
      
      showToast('Template saved successfully', 'success');
    })
    .catch(error => {
      console.error('Error saving template:', error);
      updateSaveIndicator('error');
      showToast('Error saving template: ' + error.message, 'danger');
    });
  }
  
  function previewTemplate() {
    if (!currentTemplate) return;
    
    let content = '';
    if (quill) {
      content = quill.getText();
    }
    
    // Highlight template fields in the preview
    const highlightedContent = content.replace(/\*\*\*/g, 
      '<span style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #ffc107; border-radius: 4px; padding: 2px 6px; font-weight: 600; color: #856404; display: inline-block; margin: 0 2px;">üìù <strong>***</strong> <em style="font-size: 0.8em; opacity: 0.7;">(field)</em></span>'
    );
    
    const previewWindow = window.open('', '_blank', 'width=800,height=600');
    previewWindow.document.write(`
      <html>
        <head>
          <title>Template Preview - ${currentTemplate.name}</title>
          <style>
            body { 
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
              font-size: 12pt; 
              line-height: 1.6; 
              margin: 2rem; 
              color: #333;
            }
            h1 { color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 0.5rem; }
            .template-info { 
              background: #f8f9fa; 
              padding: 1rem; 
              border-radius: 8px; 
              margin-bottom: 2rem; 
            }
            .template-fields-info {
              background: #e7f3ff;
              border: 1px solid #b3d9ff;
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1rem;
            }
            .template-fields-info h3 {
              margin-top: 0;
              color: #0066cc;
            }
          </style>
        </head>
        <body>
          <h1>Template Preview: ${escapeHtml(currentTemplate.name)}</h1>
          <div class="template-info">
            <p><strong>Template Name:</strong> ${escapeHtml(currentTemplate.name)}</p>
            <p><strong>Default Title:</strong> ${escapeHtml(currentTemplate.title || 'None')}</p>
            <p><strong>Template Fields Found:</strong> ${templateFieldCount}</p>
          </div>
          ${templateFieldCount > 0 ? `
          <div class="template-fields-info">
            <h3>üìù Template Fields</h3>
            <p>The highlighted sections below are template fields that will be replaced with actual values when creating an operative note from this template.</p>
          </div>
          ` : ''}
          <div style="white-space: pre-wrap; line-height: 1.8;">${highlightedContent}</div>
        </body>
      </html>
    `);
    previewWindow.document.close();
  }
  
  function createOpNoteFromTemplate() {
    if (!currentTemplate) return;
    
    // Populate the modal with template's default title
    const titleInput = document.getElementById('opNoteTitle');
    if (titleInput && currentTemplate.title) {
      titleInput.value = currentTemplate.title;
    }
    
    // Clear other fields
    document.getElementById('patientFirstName').value = '';
    document.getElementById('patientLastName').value = '';
    document.getElementById('operationDate').value = '';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('createOpNoteModal'));
    modal.show();
  }
  
  function submitCreateOpNote() {
    const form = document.getElementById('createOpNoteForm');
    const formData = new FormData(form);
    
    // Get current template content
    let templateContent = '';
    if (quill) {
      templateContent = quill.getText();
    }
    
    // Prepare the request data
    const requestData = {
      title: formData.get('title') || currentTemplate.title || 'Untitled Operative Note',
      patient_first_name: formData.get('patient_first_name') || null,
      patient_last_name: formData.get('patient_last_name') || null,
      operation_datetime_start: formData.get('operation_datetime_start') || null,
      text: templateContent || null
    };
    
    // Validate required fields
    if (!requestData.title.trim()) {
      showToast('Please enter a title for the operative note', 'warning');
      return;
    }
    
    console.log('Creating operative note from template:', requestData);
    
    // Show loading state
    const submitBtn = document.querySelector('#createOpNoteModal .btn-primary');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Creating...';
    submitBtn.disabled = true;
    
    // Submit to API
    fetch('/api/v1/opnote/', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Operative note created:', data);
      
      // Hide modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('createOpNoteModal'));
      modal.hide();
      
      // Show success message
      showToast('Operative note created successfully! Redirecting to editor...', 'success');
      
      // Redirect to the operative note editor
      setTimeout(() => {
        window.location.href = `/editor/${data.id}`;
      }, 1500);
    })
    .catch(error => {
      console.error('Error creating operative note:', error);
      showToast('Error creating operative note: ' + error.message, 'danger');
    })
    .finally(() => {
      // Restore button state
      submitBtn.innerHTML = originalBtnText;
      submitBtn.disabled = false;
    });
  }
  
  function setupAutoSave() {
    // Auto-save every 30 seconds if there are unsaved changes
    autoSaveInterval = setInterval(() => {
      if (hasUnsavedChanges && !isLoading && currentTemplate) {
        console.log('Auto-saving template...');
        saveTemplate();
      }
    }, 30000); // 30 seconds
  }
  
  function setupChangeListeners() {
    const headerNameInput = document.getElementById('templateName');
    const nameInput = document.getElementById('templateNameField');
    const titleInput = document.getElementById('defaultTitle');
    
    // Header name input
    if (headerNameInput) {
      headerNameInput.addEventListener('input', function() {
        const hasChanged = this.value !== (currentTemplate?.name || '');
        if (hasChanged && !isInitialLoad) {
          hasUnsavedChanges = true;
          updateSaveIndicator('modified');
          this.classList.add('modified');
          // Sync with the field input
          if (nameInput) nameInput.value = this.value;
        } else {
          this.classList.remove('modified');
        }
      });
      
      // Save on Enter key
      headerNameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur();
        }
      });
    }
    
    // Template name field
    if (nameInput) {
      nameInput.addEventListener('input', function() {
        const hasChanged = this.value !== (currentTemplate?.name || '');
        if (hasChanged && !isInitialLoad) {
          hasUnsavedChanges = true;
          updateSaveIndicator('modified');
          this.classList.add('modified');
          // Sync with header input
          if (headerNameInput) headerNameInput.value = this.value;
        } else {
          this.classList.remove('modified');
        }
      });
      
      nameInput.addEventListener('blur', function() {
        if (hasUnsavedChanges && this.value !== (currentTemplate?.name || '')) {
          console.log('Name changed, auto-saving...');
          saveTemplate();
        }
      });
    }
    
    // Default title field
    if (titleInput) {
      titleInput.addEventListener('input', function() {
        const hasChanged = this.value !== (currentTemplate?.title || '');
        if (hasChanged && !isInitialLoad) {
          hasUnsavedChanges = true;
          updateSaveIndicator('modified');
          this.classList.add('modified');
        } else {
          this.classList.remove('modified');
        }
      });
      
      titleInput.addEventListener('blur', function() {
        if (hasUnsavedChanges && this.value !== (currentTemplate?.title || '')) {
          console.log('Title changed, auto-saving...');
          saveTemplate();
        }
      });
    }
  }
  
  function setupBeforeUnload() {
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      }
    });
  }
  
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      // Check for Ctrl+S (Windows/Linux) or Cmd+S (Mac)
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault(); // Prevent browser's default save behavior
        console.log('Save shortcut detected');
        saveTemplate();
      }
    });
  }
  
  function updateSaveIndicator(state) {
    const indicator = document.getElementById('saveIndicator');
    const spinner = document.getElementById('saveSpinner');
    const saveIcon = document.getElementById('saveIcon');
    const errorIcon = document.getElementById('errorIcon');
    const message = document.getElementById('saveMessage');
    const unsavedIndicator = document.getElementById('unsavedIndicator');
    
    // Reset
    indicator.className = 'save-indicator';
    spinner.style.display = 'none';
    saveIcon.style.display = 'none';
    errorIcon.style.display = 'none';
    
    switch(state) {
      case 'saving':
        indicator.className = 'save-indicator saving show';
        spinner.style.display = 'inline-block';
        message.textContent = 'Saving...';
        if (unsavedIndicator) unsavedIndicator.style.display = 'none';
        break;
      case 'saved':
        indicator.className = 'save-indicator saved show';
        saveIcon.style.display = 'inline-block';
        message.textContent = 'Saved';
        if (unsavedIndicator) unsavedIndicator.style.display = 'none';
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
        break;
      case 'error':
        indicator.className = 'save-indicator error show';
        errorIcon.style.display = 'inline-block';
        message.textContent = 'Error saving';
        if (unsavedIndicator) unsavedIndicator.style.display = 'inline-block';
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 5000);
        break;
      case 'modified':
        indicator.className = 'save-indicator show';
        message.textContent = 'Unsaved changes';
        if (unsavedIndicator) unsavedIndicator.style.display = 'inline-block';
        break;
    }
  }
  
  function showLoading(show) {
    isLoading = show;
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
      overlay.classList.add('show');
    } else {
      overlay.classList.remove('show');
    }
  }
  
  function backToTemplates() {
    if (hasUnsavedChanges) {
      if (!confirm('You have unsaved changes. Are you sure you want to leave?')) {
        return;
      }
    }
    window.location.href = '/templates';
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function toggleHelpPanel() {
    const helpPanel = document.getElementById('helpPanel');
    const editorContainer = document.querySelector('.editor-container');
    const helpToggleBtn = document.getElementById('helpToggleBtn');
    
    if (helpPanel && editorContainer && helpToggleBtn) {
      const isOpen = helpPanel.classList.contains('open');
      
      if (isOpen) {
        // Close panel
        helpPanel.classList.remove('open');
        editorContainer.classList.remove('panel-open');
        helpToggleBtn.classList.remove('panel-open');
      } else {
        // Open panel
        helpPanel.classList.add('open');
        editorContainer.classList.add('panel-open');
        helpToggleBtn.classList.add('panel-open');
      }
    }
  }
  
  // Toast notification function - use global function from base.html
  // No need to redefine here since it's already available globally
  
  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (autoSaveInterval) {
      clearInterval(autoSaveInterval);
    }
  });
</script>
{% endblock %}
