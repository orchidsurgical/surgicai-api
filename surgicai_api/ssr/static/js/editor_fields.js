(function(){let C=null,m=!1;function v(){const e=E();if(!e){console.warn("No Quill instance found for field initialization");return}C=e,isFieldsActive=!0,console.log("Fields functionality initialized successfully"),console.log("Quill instance:",e)}function E(){let e=window.quill;if(!e&&window.Quill){const t=document.getElementById("editor");t&&t.__quill&&(e=t.__quill)}return e}function R(){const e=C;if(!e)return;if(m){console.log("Already applying styling, skipping...");return}m=!0,console.log("Applying field styling...");const t=e.container.querySelector(".ql-editor");if(!t){console.log("No editor element found"),m=!1;return}const o=e.getSelection(),l=e.hasFocus();let n=null;if(o&&l){const i=window.getSelection();i.rangeCount>0&&(n=i.getRangeAt(0).cloneRange())}const r=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1),s=[];let d;for(;d=r.nextNode();)/\[(ai)?field:\s*([^\]]+)\]([\s\S]*?)\[\/(?:\1)?field\]/.test(d.textContent)&&s.push(d);if(s.length===0){m=!1;return}s.forEach(i=>{const x=i.textContent,b=/\[(ai)?field:\s*([^\]]+)\]([\s\S]*?)\[\/(?:\1)?field\]/g;let f;const h=[];for(;(f=b.exec(x))!==null;)h.push({fullMatch:f[0],fieldName:f[2].trim(),content:f[3],isAIField:f[1]==="ai",startIndex:f.index,endIndex:f.index+f[0].length});if(h.length>0){const p=i.parentNode;let w=x,S=0;h.forEach(u=>{const F=document.createElement("div");F.innerHTML=u.isAIField?q(u.fieldName,u.content):$(u.fieldName,u.content);const I=F.firstChild,N=w.substring(0,u.startIndex-S),T=w.substring(u.endIndex-S);if(N){const a=document.createTextNode(N);p.insertBefore(a,i)}p.insertBefore(I,i);const g=I.querySelector(".field-content");if(g&&!g.hasAttribute("data-listeners-added")&&(g.addEventListener("input",function(){if(this.textContent.trim()===""){this.textContent="***";const a=document.createRange(),c=window.getSelection();a.selectNodeContents(this),c.removeAllRanges(),c.addRange(a)}}),g.addEventListener("focus",function(){this.textContent.trim()==="***"&&setTimeout(()=>{const a=document.createRange(),c=window.getSelection();a.selectNodeContents(this),c.removeAllRanges(),c.addRange(a)},1)}),g.addEventListener("blur",function(){this.textContent.trim()===""&&(this.textContent="***")}),g.addEventListener("paste",function(a){a.stopPropagation();const c=window.getSelection();if(c.rangeCount>0){const y=c.getRangeAt(0),D=(a.clipboardData||window.clipboardData).getData("text/plain");y.deleteContents();const A=document.createTextNode(D);y.insertNode(A),y.setStartAfter(A),y.setEndAfter(A),c.removeAllRanges(),c.addRange(y)}a.preventDefault()}),g.setAttribute("data-listeners-added","true")),T===""||T.charAt(0)!==" "){const a=document.createTextNode("â€‹");p.insertBefore(a,i)}w=T,S=u.endIndex}),w?i.textContent=w:p.removeChild(i)}}),l&&setTimeout(()=>{try{if(e.focus(),n){const i=window.getSelection();i.removeAllRanges(),i.addRange(n)}else o&&e.setSelection(o.index,o.length,"silent")}catch(i){console.log("Could not restore cursor position:",i),e.focus()}},1),setTimeout(()=>{m=!1,console.log("Styling application complete")},10)}function $(e,t){const o=`field-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;t=t||"***";const l=`<span class="field-component" data-field-text="[field: ${e}][/field]" data-field-name="${e}" id="${o}" contenteditable="false" style="display: inline-block; background: #fefce8; border: 1px solid #eab308; border-radius: 4px; padding: 2px 6px 4px 6px; margin: 0 2px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; cursor: default; vertical-align: baseline; line-height: 1.2; isolation: isolate;">
            <span class="field-content" style="display: block; font-size: 1em; color: #92400e; font-weight: 500; line-height: 1; word-wrap: break-word; white-space: pre-wrap; cursor: text; outline: none; caret-color: #92400e;" contenteditable="true">${t}</span>
        </span>`;return console.log("Generated field HTML:",l),l}function q(e,t){const o=`aifield-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;t=t||"{auto-generated field}";const l=`<span class="aifield-component" data-field-text="[aifield: ${e}][/aifield]" data-field-name="${e}" id="${o}" contenteditable="false" style="display: inline-block; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 4px; padding: 2px 6px 4px 6px; margin: 0 2px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; cursor: default; vertical-align: baseline; line-height: 1.2; isolation: isolate;">
            <span class="field-content" style="display: block; font-size: 1em; color: #1e40af; font-weight: 500; line-height: 1; word-wrap: break-word; white-space: pre-wrap; cursor: text; outline: none; caret-color: #1e40af;" contenteditable="true">${t}</span>
        </span>`;return console.log("Generated AI field HTML:",l),l}function L(){const e=C;if(!e)return console.warn("No Quill instance found for parsing"),"";const t=e.container.querySelector(".ql-editor");if(!t)return console.warn("No editor element found for parsing"),e.getText();const o=t.cloneNode(!0);o.querySelectorAll(".field-component, .aifield-component").forEach(d=>{const i=d.getAttribute("data-field-name"),x=d.querySelector(".field-content"),b=x?x.textContent:"",h=d.classList.contains("aifield-component")?`[aifield: ${i}]${b}[/aifield]`:`[field: ${i}]${b}[/field]`,p=document.createTextNode(h);d.parentNode.replaceChild(p,d)});let n=o.innerHTML;n=n.replace(/<br\s*\/?>/gi,`
`),n=n.replace(/<\/p>/gi,`
`),n=n.replace(/<p[^>]*>/gi,""),n=n.replace(/<div[^>]*>/gi,""),n=n.replace(/<\/div>/gi,`
`);const r=document.createElement("div");r.innerHTML=n;let s=r.textContent||r.innerText||"";return s=s.replace(/\n\s*\n\s*\n/g,`

`),s=s.trim(),s}function k(e=!1){const t=document.querySelectorAll(".field-content");if(t.length===0)return!1;const o=document.activeElement;let l=-1;o&&o.classList.contains("field-content")&&(l=Array.from(t).indexOf(o));let n;l===-1?n=e?t.length-1:0:e?n=(l-1+t.length)%t.length:n=(l+1)%t.length;const r=t[n];return r?(r.focus(),setTimeout(()=>{const s=document.createRange(),d=window.getSelection();r.textContent.trim()==="***"?s.selectNodeContents(r):(s.selectNodeContents(r),s.collapse(!1)),d.removeAllRanges(),d.addRange(s)},1),!0):!1}function M(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){setTimeout(v,100)}):setTimeout(v,100)}window.applyFieldStyling=R,window.parseQuillTextWithFields=L,window.navigateToNextField=k,M()})();
