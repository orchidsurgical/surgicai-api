(function(){let C=null,T=!1;function A(){const e=R();if(!e){console.warn("No Quill instance found for field initialization");return}C=e,isFieldsActive=!0,console.log("Fields functionality initialized successfully"),console.log("Quill instance:",e)}function R(){let e=window.quill;if(!e&&window.Quill){const t=document.getElementById("editor");t&&t.__quill&&(e=t.__quill)}return e}function v(){const e=C;if(!e)return;if(T){console.log("Already applying styling, skipping...");return}T=!0,console.log("Applying field styling...");const t=e.container.querySelector(".ql-editor");if(!t){console.log("No editor element found"),T=!1;return}const s=e.getSelection(),r=e.hasFocus();let a=null;if(s&&r){const i=window.getSelection();i.rangeCount>0&&(a=i.getRangeAt(0).cloneRange())}const d=[];let c=0;const g=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);let u;for(;u=g.nextNode();){const i=u.textContent;d.push({node:u,startPos:c,endPos:c+i.length,text:i}),c+=i.length}let o=t.innerHTML;if(t.querySelectorAll(".field-component, .aifield-component").length>0){console.log("Existing field components found, skipping styling"),T=!1;return}o=o.replace(/<br\s*\/?>/gi,`
`),o=o.replace(/<\/p><p[^>]*>/gi,`
`),o=o.replace(/<p[^>]*>/gi,""),o=o.replace(/<\/p>/gi,"");const l=document.createElement("div");l.innerHTML=o;const f=l.textContent||l.innerText||"";if(console.log("Searchable text:",JSON.stringify(f)),!/\[(ai)?field:\s*([^\]]+?)\]([\s\S]*?)\[\/(?:\1)?field\]/s.test(f)){T=!1;return}const N=[],$=/\[(ai)?field:\s*([^\]]+?)\]([\s\S]*?)\[\/(?:\1)?field\]/gs;let y;for(;(y=$.exec(f))!==null;)N.push({fullMatch:y[0],fieldName:y[2].trim(),content:y[3],isAIField:y[1]==="ai",startIndex:y.index,endIndex:y.index+y[0].length});if(N.length===0){T=!1;return}let b=t.innerHTML;N.reverse().forEach(i=>{const h=i.isAIField?L(i.fieldName,i.content):I(i.fieldName,i.content),p=new RegExp("\\["+(i.isAIField?"ai":"")+"field:\\s*"+i.fieldName.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"\\]([\\s\\S]*?)\\[\\/"+(i.isAIField?"ai":"")+"field\\]","i");b=b.replace(p,h)}),t.innerHTML=b,t.querySelectorAll(".field-component, .aifield-component").forEach(i=>{const h=i.querySelector(".field-content");h&&!h.hasAttribute("data-listeners-added")&&(h.addEventListener("input",function(){if(this.textContent.trim()===""){this.textContent="***";const p=document.createRange(),m=window.getSelection();p.selectNodeContents(this),m.removeAllRanges(),m.addRange(p)}}),h.addEventListener("focus",function(){this.textContent.trim()==="***"&&setTimeout(()=>{const p=document.createRange(),m=window.getSelection();p.selectNodeContents(this),m.removeAllRanges(),m.addRange(p)},1)}),h.addEventListener("blur",function(){this.textContent.trim()===""&&(this.textContent="***")}),h.addEventListener("paste",function(p){p.stopPropagation();const m=window.getSelection();if(m.rangeCount>0){const S=m.getRangeAt(0),H=(p.clipboardData||window.clipboardData).getData("text/plain");S.deleteContents();const F=document.createTextNode(H);S.insertNode(F),S.setStartAfter(F),S.setEndAfter(F),m.removeAllRanges(),m.addRange(S)}p.preventDefault()}),h.setAttribute("data-listeners-added","true"))}),r&&setTimeout(()=>{try{if(e.focus(),a){const i=window.getSelection();i.removeAllRanges(),i.addRange(a)}else s&&e.setSelection(s.index,s.length,"silent")}catch(i){console.log("Could not restore cursor position:",i),e.focus()}},1),setTimeout(()=>{T=!1,console.log("Styling application complete")},10)}function I(e,t){const s=`field-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;t=t||"***";const r=`<span class="field-component" data-field-text="[field: ${e}][/field]" data-field-name="${e}" id="${s}" contenteditable="false" style="display: inline-block; background: #fefce8; border: 1px solid #eab308; border-radius: 4px; padding: 2px 6px 4px 6px; margin: 0 2px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; cursor: default; vertical-align: baseline; line-height: 1.2; isolation: isolate;">
            <span class="field-content" style="display: block; font-size: 1em; color: #92400e; font-weight: 500; line-height: 1; word-wrap: break-word; white-space: pre-wrap; cursor: text; outline: none; caret-color: #92400e;" contenteditable="true">${t}</span>
        </span>`;return console.log("Generated field HTML:",r),r}function L(e,t){const s=`aifield-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;t=t||"{auto-generated field}";const r=`<span class="aifield-component" data-field-text="[aifield: ${e}][/aifield]" data-field-name="${e}" id="${s}" contenteditable="false" style="display: inline-block; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 4px; padding: 2px 6px 4px 6px; margin: 0 2px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; cursor: default; vertical-align: baseline; line-height: 1.2; isolation: isolate;">
            <span class="field-content" style="display: block; font-size: 1em; color: #1e40af; font-weight: 500; line-height: 1; word-wrap: break-word; white-space: pre-wrap; cursor: text; outline: none; caret-color: #1e40af;" contenteditable="true">${t}</span>
        </span>`;return console.log("Generated AI field HTML:",r),r}function q(){const e=C;if(!e)return console.warn("No Quill instance found for parsing"),"";const t=e.container.querySelector(".ql-editor");if(!t)return console.warn("No editor element found for parsing"),e.getText();const s=t.cloneNode(!0);s.querySelectorAll(".field-component, .aifield-component").forEach(g=>{const u=g.getAttribute("data-field-name"),w=g.querySelector(".field-content"),o=w?w.textContent:"",l=g.classList.contains("aifield-component")?`[aifield: ${u}]${o}[/aifield]`:`[field: ${u}]${o}[/field]`,f=document.createTextNode(l);g.parentNode.replaceChild(f,g)});let a=s.innerHTML;a=a.replace(/<br\s*\/?>/gi,`
`),a=a.replace(/<\/p>/gi,`
`),a=a.replace(/<p[^>]*>/gi,""),a=a.replace(/<div[^>]*>/gi,""),a=a.replace(/<\/div>/gi,`
`);const d=document.createElement("div");d.innerHTML=a;let c=d.textContent||d.innerText||"";return c=c.replace(/\n\s*\n\s*\n/g,`

`),c=c.trim(),c}function k(e=!1){const t=document.querySelectorAll(".field-content"),s=C,r=s?s.container.querySelector(".ql-editor"):document.querySelector(".ql-editor"),a=[];if(r){const n=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,{acceptNode:function(f){return f.textContent.includes("***")&&!f.parentElement.closest(".field-component, .aifield-component")?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},!1);let l;for(;l=n.nextNode();){const f=l.textContent;let x;const N=/\*\*\*/g;for(;(x=N.exec(f))!==null;)a.push({textNode:l,startOffset:x.index,endOffset:x.index+3})}}const d=[];if(t.forEach(n=>{d.push({type:"field",element:n,position:E(n)})}),a.forEach(n=>{d.push({type:"asterisk",textNode:n.textNode,startOffset:n.startOffset,endOffset:n.endOffset,position:E(n.textNode)})}),d.length===0)return!1;d.sort((n,l)=>n.position-l.position);const c=document.activeElement,g=window.getSelection();let u=-1;if(c&&c.classList.contains("field-content"))u=d.findIndex(n=>n.type==="field"&&n.element===c);else if(g.rangeCount>0){const n=g.getRangeAt(0),l=n.startContainer,f=n.startOffset;u=d.findIndex(x=>x.type==="asterisk"&&x.textNode===l&&f>=x.startOffset&&f<=x.endOffset)}let w;u===-1?w=e?d.length-1:0:e?w=(u-1+d.length)%d.length:w=(u+1)%d.length;const o=d[w];if(o){if(o.type==="field")o.element.focus(),setTimeout(()=>{const n=document.createRange(),l=window.getSelection();o.element.textContent.trim()==="***"?n.selectNodeContents(o.element):(n.selectNodeContents(o.element),n.collapse(!1)),l.removeAllRanges(),l.addRange(n)},1);else if(o.type==="asterisk"){const n=document.createRange(),l=window.getSelection();n.setStart(o.textNode,o.startOffset),n.setEnd(o.textNode,o.endOffset),l.removeAllRanges(),l.addRange(n),s&&s.focus()}return!0}return!1}function E(e){let t=0;const s=document.createTreeWalker(document.body,NodeFilter.SHOW_ALL,null,!1);let r;for(;r=s.nextNode();){if(r===e)return t;t++}return t}function O(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){setTimeout(A,100)}):setTimeout(A,100)}window.applyFieldStyling=v,window.parseQuillTextWithFields=q,window.navigateToNextField=k,O()})();
