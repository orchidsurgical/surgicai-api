{% extends "base.html" %}

{% block title %}Document Editor - OperativeAI{% endblock %}

{% block head %}
<link href="{{ url_for('static', filename='css/quill.snow.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
<style>
  .editor-container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: margin-right 0.3s ease;
  }
  
  .editor-container.panel-open {
    margin-right: 350px;
  }
  
  .editor-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .editor-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    outline: none;
    cursor: text;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  
  .editor-title:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .editor-title:focus {
    background-color: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
  }
  
  .editor-title::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }
  
  .editor-title.modified {
    box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5);
  }
  
  .editor-title.modified::after {
    content: "*";
    color: rgba(255, 193, 7, 0.8);
    margin-left: 0.25rem;
  }
  
  .editor-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.9rem;
  }
  
  .status-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
  }
  
  .unsaved-indicator {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    background: rgba(255, 193, 7, 0.2);
    color: rgba(255, 193, 7, 0.9);
    backdrop-filter: blur(10px);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }
  
  .patient-info {
    background: #f8f9fa;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
  }
  
  .patient-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  
  .info-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .info-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .info-value {
    font-size: 1rem;
    color: var(--dark-text);
    font-weight: 500;
  }
  
  .editor-toolbar {
    background: white;
    padding: 1rem 2rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: between;
    align-items: center;
    gap: 1rem;
  }
  
  .toolbar-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .toolbar-separator {
    width: 1px;
    height: 24px;
    background: #dee2e6;
    margin: 0 0.5rem;
  }
  
  .editor-content {
    padding: 0;
    min-height: 500px;
  }
  
  .quill-container {
    border: none;
    height: 500px;
  }
  
  .ql-editor {
    padding: 2rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    font-size: 12pt !important;
    line-height: 1.6;
    color: var(--dark-text);
    min-height: 456px;
  }
  
  .ql-editor.ql-blank::before {
    left: 2rem;
    right: 2rem;
    font-style: italic;
    color: #999;
  }
  
  .ql-toolbar {
    display: none !important;
  }
  
  .ql-toolbar .ql-formats {
    margin-right: 1rem;
  }
  
  .save-indicator {
    position: fixed;
    top: 100px;
    right: 20px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 1000;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(-10px);
  }
  
  .save-indicator.show {
    opacity: 1;
    transform: translateY(0);
  }
  
  .save-indicator.saving {
    background: #fff3cd;
    border-color: #ffc107;
    color: #856404;
  }
  
  .save-indicator.saved {
    background: #d1e7dd;
    border-color: #198754;
    color: #0a3622;
  }
  
  .save-indicator.error {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
  }
  
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  @keyframes recording-pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
  }
  
  .action-buttons {
    display: flex;
    gap: 1rem;
    margin-left: auto;
  }
  
  .btn-outline-primary {
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    background: transparent;
  }
  
  .btn-outline-primary:hover {
    background: var(--primary-color);
    color: white;
  }

  .btn-dictating {
    background: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
    animation: recording-pulse 1.5s infinite;
  }
  
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .loading-overlay.show {
    opacity: 1;
    visibility: visible;
  }
  
  .loading-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @media (max-width: 768px) {
    .editor-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .patient-info-grid {
      grid-template-columns: 1fr;
    }
    
    .editor-toolbar {
      padding: 1rem;
    }
    
    .ql-editor {
      padding: 1rem;
    }
    
    .save-indicator {
      right: 10px;
      top: 80px;
    }
    
    .editor-container.panel-open {
      margin-right: 0;
    }
    
    .help-panel {
      width: 100% !important;
      right: -100% !important;
    }
    
    .help-panel.open {
      right: 0 !important;
    }
  }
  
  /* Help Panel Styles */
  .help-panel {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100vh;
    background: white;
    border-left: 1px solid #e9ecef;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: right 0.3s ease;
    overflow-y: auto;
  }
  
  .help-panel.open {
    right: 0;
  }
  
  .help-panel-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1002;
  }
  
  .help-panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
  }
  
  .help-panel-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }
  
  .help-panel-close:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .help-panel-content {
    padding: 1.5rem;
  }
  
  .help-section {
    margin-bottom: 2rem;
  }
  
  .help-section:last-child {
    margin-bottom: 0;
  }
  
  .help-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .help-section-content {
    color: #333;
    line-height: 1.6;
  }
  
  .help-section-content p {
    margin-bottom: 0.75rem;
  }
  
  .help-section-content p:last-child {
    margin-bottom: 0;
  }
  
  .help-code {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    margin: 0.5rem 0;
    display: block;
  }
  
  .help-example {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 6px;
    padding: 1rem;
    margin: 0.75rem 0;
  }
  
  .help-example-title {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  
  .help-example-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.85rem;
    color: #333;
    white-space: pre-wrap;
  }
  
  .keyboard-shortcut {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .keyboard-shortcut:last-child {
    border-bottom: none;
  }
  
  .shortcut-description {
    color: #333;
    font-size: 0.9rem;
  }
  
  .shortcut-keys {
    display: flex;
    gap: 0.25rem;
  }
  
  .shortcut-key {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    color: #333;
    min-width: 1.5rem;
    text-align: center;
  }
  
  .help-toggle-btn {
    position: fixed;
    top: 50%;
    right: 20px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transform: translateY(-50%);
  }
  
  .help-toggle-btn:hover {
    background: var(--secondary-color);
    transform: translateY(-50%) scale(1.05);
  }
  
  .help-toggle-btn.panel-open {
    right: 370px;
  }

  /* Field Component Styles */
  .field-component {
    display: inline-block;
    position: relative;
    background: #fefce8;
    border: 1px solid #eab308;
    border-radius: 4px;
    padding: 2px 6px 4px 6px;
    margin: 0 2px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    cursor: default;
    vertical-align: baseline;
    line-height: 1.2;
    isolation: isolate;
  }
  
  .field-component .field-label {
    display: block;
    font-size: 9px;
    color: #a16207;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    line-height: 1;
    margin-bottom: 1px;
  }
  
  .field-component .field-content {
    display: block;
    font-size: 12px;
    color: #92400e;
    font-weight: 500;
    line-height: 1;
  }
  
  .field-component:hover {
    background: #fef3c7;
    border-color: #d97706;
  }
  
  /* AI Field Component Styles */
  .aifield-component {
    display: inline-block;
    position: relative;
    background: #dbeafe;
    border: 1px solid #3b82f6;
    border-radius: 4px;
    padding: 2px 6px 4px 6px;
    margin: 0 2px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    cursor: default;
    vertical-align: baseline;
    line-height: 1.2;
    isolation: isolate;
  }
  
  .aifield-component .field-label {
    display: block;
    font-size: 9px;
    color: #1d4ed8;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    line-height: 1;
    margin-bottom: 1px;
  }
  
  .aifield-component .field-content {
    display: block;
    font-size: 12px;
    color: #1e40af;
    font-weight: 500;
    line-height: 1;
  }
  
  .aifield-component:hover {
    background: #bfdbfe;
    border-color: #2563eb;
  }
  
  /* Make sure field components don't break layout and don't affect adjacent text */
  .ql-editor .field-component,
  .ql-editor .aifield-component {
    white-space: nowrap;
  }
  
  /* Ensure text after fields inherits proper styling */
  .ql-editor .field-component + *,
  .ql-editor .aifield-component + * {
    color: inherit;
    background: inherit;
    font-family: inherit;
  }
</style>
{% endblock %}

{% block content %}
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div>Loading operative note...</div>
  </div>
</div>

<div class="container-fluid py-4">
  <div class="editor-container">
    <div class="editor-header">
      <input type="text" class="editor-title" id="documentTitle" placeholder="Enter document title..." maxlength="255">
      <div class="editor-status">
        <span class="unsaved-indicator" id="unsavedIndicator" style="display: none;">
          <i class="bi bi-exclamation-circle me-1"></i>Unsaved changes
        </span>
        <span id="lastUpdated">...</span>
      </div>
    </div>
    
    <div class="patient-info" id="patientInfo">
      <div class="patient-info-grid">

        <div class="info-field">
          <div class="info-label">Operation Start</div>
          <div class="info-value" id="operationStart">-</div>
        </div>
        <div class="info-field">
          <div class="info-label">Operation End</div>
          <div class="info-value" id="operationEnd">-</div>
        </div>
        <div class="info-field">
            <div class="info-label">Suggested Billing Codes <i class="bi bi-info-circle-fill text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Billing codes are generated using AI, based on your operative note, for maximized billables."></i></div>
            <div class="info-value" id="billingCodes">-</div>
        </div>
      </div>
    </div>
    
    <div class="editor-toolbar">
      <div class="toolbar-group">
        <button class="btn btn-sm btn-outline-primary" onclick="editPatientInfo()">
          <i class="bi bi-pencil me-1"></i>Edit Operation Info
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="navigateToNextFieldButton()">
          <i class="bi bi-arrow-right-circle me-1"></i>Next Field
        </button>
      </div>
      <div class="toolbar-separator"></div>
      <div class="toolbar-group">
        <button class="btn btn-sm btn-outline-primary" id="dictationButton" onclick="startDictation()">
          <i class="bi bi-mic me-1"></i>Start Dictation
      </div>
      <div class="action-buttons">
        <button class="btn btn-sm btn-primary" onclick="">
          <i class="bi bi-magic me-1"></i>Optimize Note
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="saveDocument()" id="saveButton">
          <i class="bi bi-save me-1"></i>Save
        </button>
        <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard()" id="copyButton">
          <i class="bi bi-clipboard me-1"></i>Copy to Clipboard
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="backToDashboard()">
          <i class="bi bi-arrow-left me-1"></i>Back
        </button>
      </div>
    </div>
    
    <div class="editor-content">
      <div id="editor"></div>
    </div>
  </div>
</div>

<div class="save-indicator" id="saveIndicator">
  <span class="spinner" id="saveSpinner" style="display: none;"></span>
  <i class="bi bi-check-circle" id="saveIcon" style="display: none;"></i>
  <i class="bi bi-exclamation-triangle" id="errorIcon" style="display: none;"></i>
  <span id="saveMessage">Saved</span>
</div>

<!-- Patient Info Modal -->
<div class="modal fade" id="patientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Operation Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="patientForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Operation Start</label>
                <input type="datetime-local" class="form-control" id="modalOperationStart" name="operation_datetime_start">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Operation End</label>
                <input type="datetime-local" class="form-control" id="modalOperationEnd" name="operation_datetime_end">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label">Change Template (Optional)</label>
                <select class="form-select" id="modalTemplateSelect" onchange="onModalTemplateSelected()">
                  <option value="">Keep current content...</option>
                  <!-- Templates will be loaded here -->
                </select>
                <div class="form-text">⚠️ Selecting a template will replace all content in the operative note</div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePatientInfo()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Template Change Confirmation Modal -->
<div class="modal fade" id="templateChangeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>Replace Content with Template?
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This action will replace all current content in your operative note.
        </div>
        <p>Are you sure you want to replace the current operative note content with the template <strong id="templateNameConfirm"></strong>?</p>
        <p class="text-muted">This action cannot be undone unless you have saved a previous version.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelTemplateChange()">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="confirmTemplateChange()">
          <i class="bi bi-arrow-repeat me-1"></i>Replace Content
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Help Panel -->
<div class="help-panel" id="helpPanel">
  <div class="help-panel-header">
    <h3 class="help-panel-title">
      <i class="bi bi-question-circle me-2"></i>Document Editor Help
    </h3>
    <button class="help-panel-close" onclick="toggleHelpPanel()" aria-label="Close help panel">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  
  <div class="help-panel-content">
    <div class="help-section">
      <div class="help-section-title">
        <i class="bi bi-keyboard"></i>
        Keyboard Shortcuts
      </div>
      <div class="help-section-content">
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Save document</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">S</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Save document (Mac)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">⌘</span>
            <span class="shortcut-key">S</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Toggle Dictation</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">D</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Toggle Dictation (Mac)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">⌘</span>
            <span class="shortcut-key">D</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Navigate to next field</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Tab</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Navigate to previous field</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Shift</span>
            <span class="shortcut-key">Tab</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Next field (alternative)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">→</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Previous field (alternative)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">Ctrl</span>
            <span class="shortcut-key">←</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Next field (Mac alternative)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">⌘</span>
            <span class="shortcut-key">→</span>
          </div>
        </div>
        <div class="keyboard-shortcut">
          <span class="shortcut-description">Previous field (Mac alternative)</span>
          <div class="shortcut-keys">
            <span class="shortcut-key">⌘</span>
            <span class="shortcut-key">←</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="help-section">
      <div class="help-section-title">
        <i class="bi bi-input-cursor-text"></i>
        Field Navigation
      </div>
      <div class="help-section-content">
        <p>Navigate between field components in your document using keyboard shortcuts or the toolbar button.</p>
        <p>When exporting, the fields will appear as plain text for import into Epic or other EHR systems.</p>
      </div>
    </div>
    
    <div class="help-section">
      <div class="help-section-title">
        <i class="bi bi-pencil-square"></i>
        Editing Tips
      </div>
      <div class="help-section-content">
        <p>The editor saves your work automatically every 30 seconds when changes are detected.</p>
        <p>Click "Edit Operation Info" to update operation dates and other metadata.</p>
      </div>
    </div>
  </div>
</div>

<!-- Help Toggle Button -->
<button class="help-toggle-btn" id="helpToggleBtn" onclick="toggleHelpPanel()" aria-label="Toggle help panel">
  <i class="bi bi-question-circle"></i>
</button>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/transcribe.js') }}"></script>
<script src="{{ url_for('static', filename='js/editor_fields.js') }}"></script>
<script>
  // Global variables
  let quill;
  let currentNote = null;
  let autoSaveInterval = null;
  let isLoading = false;
  let hasUnsavedChanges = false;
  let isInitialLoad = true; // Flag to prevent triggering unsaved changes during initial load
  let lastCursorPosition = 0; // Track last known cursor position
  let allTemplates = []; // Store available templates
  let pendingTemplateChange = null; // Store pending template change data
  
  // Initialize the editor
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Editor page loaded');
    
    // Wait for Quill to load
    function waitForQuill() {
      if (typeof Quill !== 'undefined') {
        console.log('Quill is available, initializing editor...');
        initializeQuill();
        loadDocument();
        setupAutoSave();
        setupBeforeUnload();
        setupTitleChangeListener();
        setupKeyboardShortcuts();
        initializeTooltips();
      } else {
        console.log('Waiting for Quill to load...');
        setTimeout(waitForQuill, 100);
      }
    }
    
    waitForQuill();
  });

  function initializeQuill() {
    try {
      const editorElement = document.getElementById('editor');
      if (!editorElement) {
        throw new Error('Editor element not found');
      }
      
      const toolbarOptions = false; // Disable all toolbar options
      
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: false, // Completely disable toolbar
          keyboard: {
            bindings: {}
          }
        },
        formats: ['field'], // Allow field format
        placeholder: 'Start typing your operative note...'
      });
      
      console.log('Quill initialized successfully');
      
      // Listen for text changes
      quill.on('text-change', function(delta, oldDelta, source) {
        if (source === 'user' && !isInitialLoad) {
          hasUnsavedChanges = true;
          updateSaveIndicator('modified');
        }
      });
      
      // Listen for selection changes to track cursor position
      quill.on('selection-change', function(range, oldRange, source) {
        if (range) {
          lastCursorPosition = range.index;
        }
      });
    } catch (error) {
      console.error('Error initializing Quill:', error);
      showToast('Error initializing editor. Please refresh the page.', 'danger');
    }
  }
  
  function loadDocument() {
    const noteId = '{{ note_id }}';
    console.log('Loading document:', noteId);
    
    showLoading(true);
    
    fetch(`/api/v1/opnote/${noteId}`, {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Document loaded:', data);
      currentNote = data;
      populateDocument(data);
      hasUnsavedChanges = false;
      // Don't show any save indicator on initial load
    })
    .catch(error => {
      console.error('Error loading document:', error);
      showToast('Error loading document: ' + error.message, 'danger');
      updateSaveIndicator('error');
    })
    .finally(() => {
      showLoading(false);
    });
  }
  
  function populateDocument(note) {
    // Update header
    document.getElementById('documentTitle').value = note.title || '';
    
    // Update last updated with better formatting
    const lastUpdated = note.updated_at ? 
      new Date(note.updated_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      }) : 'Never';
    document.getElementById('lastUpdated').textContent = 'Last updated: ' + lastUpdated;
    
    // Format dates for display
    const formatDate = (dateStr) => {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    };
    
    document.getElementById('operationStart').textContent = formatDate(note.operation_datetime_start);
    document.getElementById('operationEnd').textContent = formatDate(note.operation_datetime_end);
    
    // Set editor content as plain text
    if (note.text && quill) {
      // Set content as plain text only
      quill.setText(note.text, 'silent');
      // Apply field styling after content is loaded
      setTimeout(() => {
        if (window.applyFieldStyling) {
          window.applyFieldStyling();
        }
      }, 100);
    } else if (note.text) {
      // Fallback if Quill isn't ready yet
      const editorElement = document.getElementById('editor');
      if (editorElement) {
        editorElement.textContent = note.text;
        // Apply field styling after content is loaded
        setTimeout(() => {
          if (window.applyFieldStyling) {
            window.applyFieldStyling();
          }
        }, 100);
      }
    }
    
    // Update button states
    updateButtonStates(note.status);
    
    // Reset initial load flag after document is fully populated
    setTimeout(() => {
      isInitialLoad = false;
    }, 200); // Increased timeout to ensure content is set
  }
  
  function updateButtonStates(status) {
    const saveButton = document.getElementById('saveButton');
    const titleInput = document.getElementById('documentTitle');
    
    if (status === 'submitted') {
      saveButton.disabled = true;
      if (titleInput) {
        titleInput.disabled = true;
        titleInput.style.cursor = 'not-allowed';
        titleInput.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
      }
      if (quill) {
        quill.disable();
      }
    } else {
      saveButton.disabled = false;
      if (titleInput) {
        titleInput.disabled = false;
        titleInput.style.cursor = 'text';
        titleInput.style.backgroundColor = 'transparent';
      }
      if (quill) {
        quill.enable();
      }
    }
  }
  
  function saveDocument() {
    if (isLoading) return;
    
    const noteId = '{{ note_id }}';
    let content = '';
    
    // Use parseQuillTextWithFields to get content with field components properly formatted
    if (window.parseQuillTextWithFields) {
      content = window.parseQuillTextWithFields();
    } else if (quill) {
      content = quill.getText().trim(); // Fallback to plain text
    } else {
      // Fallback to get content from editor element
      const editorElement = document.getElementById('editor');
      if (editorElement) {
        content = editorElement.textContent || editorElement.innerText || '';
      }
    }
    
    const titleInput = document.getElementById('documentTitle');
    const title = titleInput ? titleInput.value.trim() : '';
    
    if (!title) {
      showToast('Please enter a title for the document', 'warning');
      titleInput?.focus();
      return;
    }
    
    const updateData = {
      title: title,
      text: content
    };
    
    console.log('Saving document:', updateData);
    updateSaveIndicator('saving');
    
    fetch(`/api/v1/opnote/${noteId}`, {
      method: 'PUT',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updateData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Document saved:', data);
      currentNote = data;
      hasUnsavedChanges = false;
      updateSaveIndicator('saved');
      
      // Remove modified class from title
      const titleInput = document.getElementById('documentTitle');
      if (titleInput) {
        titleInput.classList.remove('modified');
      }
      
      // Update last updated time with better formatting
      const lastUpdated = new Date(data.updated_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      document.getElementById('lastUpdated').textContent = 'Last updated: ' + lastUpdated;      
    })
    .catch(error => {
      console.error('Error saving document:', error);
      updateSaveIndicator('error');
      showToast('Error saving document: ' + error.message, 'danger');
    });
  }
  
  function editPatientInfo() {
    if (!currentNote) return;
    
    // Format dates for datetime-local inputs
    const formatForInput = (dateStr) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      // Format for datetime-local input
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    
    document.getElementById('modalOperationStart').value = formatForInput(currentNote.operation_datetime_start);
    document.getElementById('modalOperationEnd').value = formatForInput(currentNote.operation_datetime_end);
    
    // Load templates and reset template dropdown
    loadTemplatesForModal();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('patientModal'));
    modal.show();
  }
  
  function savePatientInfo() {
    if (isLoading) return;
    
    const noteId = '{{ note_id }}';
    const formData = new FormData(document.getElementById('patientForm'));
    
    // Convert datetime-local values to proper format for API
    const updateData = {
      operation_datetime_start: formData.get('operation_datetime_start') || null,
      operation_datetime_end: formData.get('operation_datetime_end') || null
    };
    
    console.log('Saving patient info:', updateData);
    
    fetch(`/api/v1/opnote/${noteId}`, {
      method: 'PUT',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updateData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Patient info saved:', data);
      currentNote = data;
      
      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
      };
      
      document.getElementById('operationStart').textContent = formatDate(data.operation_datetime_start);
      document.getElementById('operationEnd').textContent = formatDate(data.operation_datetime_end);
      
      // Update last updated time with better formatting
      const lastUpdated = new Date(data.updated_at).toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      document.getElementById('lastUpdated').textContent = 'Last updated: ' + lastUpdated;
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('patientModal'));
      modal.hide();
      
      showToast('Operation information updated successfully', 'success');
    })
    .catch(error => {
      console.error('Error saving patient info:', error);
      showToast('Error saving operation information: ' + error.message, 'danger');
    });
  }
  
  function setupAutoSave() {
    // Auto-save every 30 seconds if there are unsaved changes
    autoSaveInterval = setInterval(() => {
      if (hasUnsavedChanges && !isLoading && currentNote && currentNote.status !== 'submitted') {
        console.log('Auto-saving document...');
        saveDocument();
      }
    }, 30000); // 30 seconds
  }
  
  function setupTitleChangeListener() {
    const titleInput = document.getElementById('documentTitle');
    if (titleInput) {
      titleInput.addEventListener('input', function() {
        const hasChanged = this.value !== (currentNote?.title || '');
        if (hasChanged && !isInitialLoad) {
          hasUnsavedChanges = true;
          updateSaveIndicator('modified');
          this.classList.add('modified');
        } else {
          this.classList.remove('modified');
        }
      });
      
      // Save title on blur if it has changed
      titleInput.addEventListener('blur', function() {
        if (hasUnsavedChanges && this.value !== (currentNote?.title || '')) {
          console.log('Title changed, auto-saving...');
          saveDocument();
        }
      });
      
      // Save title on Enter key
      titleInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.blur(); // Trigger blur event to save
        }
      });
    }
  }
  
  function setupBeforeUnload() {
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      }
    });
  }
  
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      // Check for Ctrl+S (Windows/Linux) or Cmd+S (Mac)
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault(); // Prevent browser's default save behavior
        console.log('Save shortcut detected');
        saveDocument();
      }

      // Check for Ctrl+D (Windows/Linux) or Cmd+D (Mac) to start/stop dictation
      if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault(); // Prevent default browser behavior
        console.log('Dictation shortcut detected');
        toggleDictation();
      }
      
      // Check for Ctrl/Cmd + Right Arrow to navigate to next field
      if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowRight') {
        e.preventDefault();
        if (window.navigateToNextField) {
          window.navigateToNextField(false); // Navigate forward
        }
      }
      
      // Check for Ctrl/Cmd + Left Arrow to navigate to previous field
      if ((e.ctrlKey || e.metaKey) && e.key === 'ArrowLeft') {
        e.preventDefault();
        if (window.navigateToNextField) {
          window.navigateToNextField(true); // Navigate backward
        }
      }
      
      // Field management shortcuts
      if (quill) {
        // Tab to go to next field - use our custom field navigation
        if (e.key === 'Tab' && !e.ctrlKey && !e.metaKey) {
          // Check if we're currently in a field component
          const activeElement = document.activeElement;
          if (activeElement && activeElement.classList.contains('field-content')) {
            e.preventDefault();
            if (window.navigateToNextField) {
              window.navigateToNextField(e.shiftKey);
            }
            return;
          }
          
          // If not in a field but fields exist on the page, navigate to first field
          const allFieldContents = document.querySelectorAll('.field-content');
          if (allFieldContents.length > 0 && window.navigateToNextField) {
            // Only intercept if we're not in an input/textarea/contenteditable that needs tab
            const tagName = activeElement?.tagName?.toLowerCase();
            const isContentEditable = activeElement?.contentEditable === 'true';
            const needsTabNavigation = ['input', 'textarea', 'select', 'button'].includes(tagName) || 
                                       (isContentEditable && !activeElement.classList.contains('ql-editor'));
            
            if (!needsTabNavigation) {
              e.preventDefault();
              window.navigateToNextField(e.shiftKey);
              return;
            }
          }
          
          // If we have the old QuillFieldBlot system, use it as fallback
          if (window.QuillFieldBlot) {
            e.preventDefault();
            if (e.shiftKey) {
              window.QuillFieldBlot.goToPreviousField(quill);
            } else {
              window.QuillFieldBlot.goToNextField(quill);
            }
          }
        }
        
        // Ctrl/Cmd+F to insert a new field
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          window.QuillFieldBlot.insertField(quill);
        }
        
        // Ctrl/Cmd+Shift+F to convert selected text to field
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'F') {
          e.preventDefault();
          window.QuillFieldBlot.convertToField(quill);
        }
      }
    });
  }
  
  function updateSaveIndicator(state) {
    const indicator = document.getElementById('saveIndicator');
    const spinner = document.getElementById('saveSpinner');
    const saveIcon = document.getElementById('saveIcon');
    const errorIcon = document.getElementById('errorIcon');
    const message = document.getElementById('saveMessage');
    const unsavedIndicator = document.getElementById('unsavedIndicator');
    
    // Reset
    indicator.className = 'save-indicator';
    spinner.style.display = 'none';
    saveIcon.style.display = 'none';
    errorIcon.style.display = 'none';
    
    switch(state) {
      case 'saving':
        indicator.className = 'save-indicator saving show';
        spinner.style.display = 'inline-block';
        message.textContent = 'Saving...';
        if (unsavedIndicator) unsavedIndicator.style.display = 'none';
        break;
      case 'saved':
        indicator.className = 'save-indicator saved show';
        saveIcon.style.display = 'inline-block';
        message.textContent = 'Saved';
        if (unsavedIndicator) unsavedIndicator.style.display = 'none';
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
        break;
      case 'error':
        indicator.className = 'save-indicator error show';
        errorIcon.style.display = 'inline-block';
        message.textContent = 'Error saving';
        if (unsavedIndicator) unsavedIndicator.style.display = 'inline-block';
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 5000);
        break;
      case 'modified':
        indicator.className = 'save-indicator show';
        message.textContent = 'Unsaved changes';
        if (unsavedIndicator) unsavedIndicator.style.display = 'inline-block';
        break;
    }
  }
  
  function showLoading(show) {
    isLoading = show;
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
      overlay.classList.add('show');
    } else {
      overlay.classList.remove('show');
    }
  }
  
  function copyToClipboard() {
    let content = '';
    // Use parseQuillTextWithFields to get content with field components properly formatted
    if (window.parseQuillTextWithFields) {
      content = window.parseQuillTextWithFields();
    } else if (quill) {
      content = quill.getText().trim(); // Fallback to plain text
    } else {
      // Fallback to get content from editor element
      const editorElement = document.getElementById('editor');
      if (editorElement) {
        content = editorElement.textContent || editorElement.innerText || '';
      }
    }
    if (!content) {
      showToast('Nothing to copy', 'warning');
      return;
    }

    // strip field tags if present
    content = content.replace(/\[field:[^\]]+\]([^\[]+?)\[\/field\]/g, '$1')
                     .replace(/\[aifield:[^\]]+\]([^\[]+?)\[\/aifield\]/g, '$1')

    navigator.clipboard.writeText(content)
      .then(() => {
        showToast('Note content copied to clipboard!', 'success');
      })
      .catch(err => {
        console.error('Failed to copy:', err);
        showToast('Failed to copy to clipboard', 'danger');
      });
  }

  function backToDashboard() {
    if (hasUnsavedChanges) {
      if (!confirm('You have unsaved changes. Are you sure you want to leave?')) {
        return;
      }
    }
    window.location.href = '/dashboard';
  }
  
  function initializeTooltips() {
    // Initialize tooltips for info icons
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }
  
  // Toast notification function - use global function from base.html
  // No need to redefine here since it's already available globally
  
  // Template management functions
  function loadTemplatesForModal() {
    fetch('/api/v1/template/', {
      method: 'GET',
      credentials: 'include'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      allTemplates = data;
      updateModalTemplateDropdown();
    })
    .catch(error => {
      console.error('Error loading templates:', error);
      // Don't show error to user, just leave dropdown empty
    });
  }
  
  function updateModalTemplateDropdown() {
    const templateSelect = document.getElementById('modalTemplateSelect');
    if (!templateSelect) return;
    
    // Clear existing options except the first one
    while (templateSelect.children.length > 1) {
      templateSelect.removeChild(templateSelect.lastChild);
    }
    
    // Add template options
    allTemplates.forEach(template => {
      const option = document.createElement('option');
      option.value = template.id;
      option.textContent = template.name;
      templateSelect.appendChild(option);
    });
    
    // Reset to default option
    templateSelect.value = '';
  }
  
  function onModalTemplateSelected() {
    const templateSelect = document.getElementById('modalTemplateSelect');
    if (!templateSelect) return;
    
    const templateId = templateSelect.value;
    
    if (!templateId) {
      // No template selected, clear pending change
      pendingTemplateChange = null;
      return;
    }
    
    // Find the selected template
    const selectedTemplate = allTemplates.find(template => template.id === templateId);
    
    if (selectedTemplate) {
      // Store the pending template change but don't apply it yet
      pendingTemplateChange = {
        templateId: templateId,
        templateName: selectedTemplate.name
      };
      
      // Show confirmation modal
      document.getElementById('templateNameConfirm').textContent = selectedTemplate.name;
      const confirmModal = new bootstrap.Modal(document.getElementById('templateChangeModal'));
      confirmModal.show();
    }
  }
  
  function cancelTemplateChange() {
    // Reset the dropdown to "Keep current content..."
    const templateSelect = document.getElementById('modalTemplateSelect');
    if (templateSelect) {
      templateSelect.value = '';
    }
    pendingTemplateChange = null;
  }
  
  function confirmTemplateChange() {
    if (!pendingTemplateChange) return;
    
    // Fetch the full template details
    fetch(`/api/v1/template/${pendingTemplateChange.templateId}`, {
      method: 'GET',
      credentials: 'include'
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(template => {
      // Replace the content in the Quill editor
      if (quill && template.text) {
        quill.setText(template.text, 'user');
        hasUnsavedChanges = true;
        updateSaveIndicator('modified');
        // Apply field styling after template content is loaded
        setTimeout(() => {
          if (window.applyFieldStyling) {
            window.applyFieldStyling();
          }
        }, 100);
      }
      
      // Close confirmation modal
      const confirmModal = bootstrap.Modal.getInstance(document.getElementById('templateChangeModal'));
      confirmModal.hide();
      
      // Clear pending change
      pendingTemplateChange = null;
      
      showToast(`Content replaced with template: ${template.name}`, 'success');
    })
    .catch(error => {
      console.error('Error loading template details:', error);
      showToast('Error loading template content', 'danger');
      cancelTemplateChange();
    });
  }
  
  function toggleHelpPanel() {
    const helpPanel = document.getElementById('helpPanel');
    const editorContainer = document.querySelector('.editor-container');
    const helpToggleBtn = document.getElementById('helpToggleBtn');
    
    if (helpPanel && editorContainer && helpToggleBtn) {
      const isOpen = helpPanel.classList.contains('open');
      
      if (isOpen) {
        // Close panel
        helpPanel.classList.remove('open');
        editorContainer.classList.remove('panel-open');
        helpToggleBtn.classList.remove('panel-open');
      } else {
        // Open panel
        helpPanel.classList.add('open');
        editorContainer.classList.add('panel-open');
        helpToggleBtn.classList.add('panel-open');
      }
    }
  }
  
  function navigateToNextFieldButton() {
    // Call the global navigation function from editor_fields.js
    if (window.navigateToNextField) {
      window.navigateToNextField(false); // false = forward direction
    } else {
      showToast('Field navigation not available', 'warning');
    }
  }
  
  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if (autoSaveInterval) {
      clearInterval(autoSaveInterval);
    }
  });
</script>
{% endblock %}
